version: '3.8'

services:
  postgres-gitea:
    image: postgres:${POSTGRES_GITEA_VERSION}
    container_name: operations-postgres-gitea
    restart: unless-stopped
    volumes:
      - ${DATA_BASE_PATH}/operations/postgres-gitea:/var/lib/postgresql/data
    environment:
      - POSTGRES_DB=${POSTGRES_DB_GITEA}
      - POSTGRES_USER=${POSTGRES_USER_GITEA}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD_GITEA}
    networks:
      - backend_net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER_GITEA} -d ${POSTGRES_DB_GITEA}"]
      interval: 10s
      timeout: 5s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  gitea:
    image: gitea/gitea:${GITEA_VERSION}
    container_name: operations-gitea
    restart: unless-stopped
    depends_on:
      postgres-gitea:
        condition: service_healthy
    volumes:
      - ${DATA_BASE_PATH}/operations/gitea:/data
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - GITEA__database__DB_TYPE=postgres
      - GITEA__database__HOST=operations-postgres-gitea:5432
      - GITEA__database__NAME=${POSTGRES_DB_GITEA}
      - GITEA__database__USER=${POSTGRES_USER_GITEA}
      - GITEA__database__PASSWD=${POSTGRES_PASSWORD_GITEA}
      - GITEA__server__DOMAIN=${GITEA_SUBDOMAIN}.${DOMAIN_NAME}
      - GITEA__server__ROOT_URL=https://${GITEA_SUBDOMAIN}.${DOMAIN_NAME}
      - GITEA__service__DISABLE_REGISTRATION=false
      - GITEA__container__ENABLE=true
      - GITEA__container__REGISTRY_HOST=${REGISTRY_SUBDOMAIN}.${DOMAIN_NAME}
      - GITEA__metrics__ENABLED=true
    networks:
      - traefik_net
      - backend_net
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.gitea-web.rule=Host(`${GITEA_SUBDOMAIN}.${DOMAIN_NAME}`)"
      - "traefik.http.routers.gitea-web.entrypoints=websecure"
      - "traefik.http.services.gitea-web.loadbalancer.server.port=3000"
      - "traefik.http.routers.gitea-registry.rule=Host(`${REGISTRY_SUBDOMAIN}.${DOMAIN_NAME}`)"
      - "traefik.http.routers.gitea-registry.entrypoints=websecure"
      - "traefik.http.services.gitea-registry.loadbalancer.server.port=3000"
    healthcheck:
      test: ["CMD-SHELL", "/usr/local/bin/gitea", "doctor", "--run", "check-database"]
      interval: 60s
      timeout: 30s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '0.25'
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  woodpecker-server:
    image: woodpeckerci/woodpecker-server:${WOODPECKER_SERVER_VERSION}
    container_name: operations-woodpecker-server
    restart: unless-stopped
    depends_on: [gitea]
    volumes:
      - ${DATA_BASE_PATH}/operations/woodpecker:/var/lib/woodpecker/
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - WOODPECKER_HOST=https://${WOODPECKER_SUBDOMAIN}.${DOMAIN_NAME}
      - WOODPECKER_GITEA=true
      - WOODPECKER_GITEA_URL=https://${GITEA_SUBDOMAIN}.${DOMAIN_NAME}
      - WOODPECKER_GITEA_CLIENT=${WOODPECKER_GITEA_CLIENT_ID}
      - WOODPECKER_GITEA_SECRET=${WOODPECKER_GITEA_CLIENT_SECRET}
      - WOODPECKER_AGENT_SECRET=${WOODPECKER_AGENT_SECRET}
      - WOODPECKER_ADMINS=${WOODPECKER_ADMIN}
    networks:
      - traefik_net
      - backend_net
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.woodpecker.rule=Host(`${WOODPECKER_SUBDOMAIN}.${DOMAIN_NAME}`)"
      - "traefik.http.routers.woodpecker.entrypoints=websecure"
      - "traefik.http.services.woodpecker.loadbalancer.server.port=8000"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  woodpecker-agent:
    image: woodpeckerci/woodpecker-agent:${WOODPECKER_AGENT_VERSION}
    container_name: operations-woodpecker-agent
    restart: unless-stopped
    depends_on: [woodpecker-server]
    volumes: []
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - WOODPECKER_SERVER=operations-woodpecker-server:9000
      - WOODPECKER_AGENT_SECRET=${WOODPECKER_AGENT_SECRET}
      - WOODPECKER_MAX_WORKFLOWS=2
      - WOODPECKER_BACKEND_DOCKER_PRIVILEGED_IMAGES=${WOODPECKER_DOCKER_PRIVILEGED_IMAGES}
    networks:
      - backend_net
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  traefik_net:
    external: true
  backend_net:
    external: true
